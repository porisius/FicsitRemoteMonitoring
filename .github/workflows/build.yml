name: CI

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "FicsitRemoteMonitoring.uplugin"
      - "Content/**"
      - "Source/**"
  pull_request:
    branches:
      - "main"
      - "dev"
    paths:
      - "Content/**"
      - "Source/**"

jobs:
  build:
    runs-on: self-hosted
    steps:

      - uses: actions/checkout@v2
        with:
          path: FicsitRemoteMontioring

      - uses: actions/checkout@master
        with:
          repository: porisius/Disc-IT
          ref: refs/heads/master
          path: DiscIT

      - uses: actions/checkout@master
        with:
          repository: porisius/JSONQuery
          ref: refs/heads/master
          path: JSONQuery

      - uses: actions/checkout@master
        with:
          repository: porisius/ArduinoKit
          ref: refs/heads/main
          path: ArduinoKit

      - name: Ensure SML Project is up to date
        run: git -C C:\SatisfactoryModLoader pull

      - name: Remove any existing mods
        run: Remove-Item "C:\\SatisfactoryModLoader\\Mods\\ArduinoKit" "C:\\SatisfactoryModLoader\\Mods\\DiscIT" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring" "C:\\SatisfactoryModLoader\\Mods\\JSONQuery"

      - name: Copy FicsitRemoteMontioring to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\FicsitRemoteMontioring" C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Copy ArduinoKit to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\ArduinoKit" C:\SatisfactoryModLoader\Mods\ArduinoKit -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Copy DiscIT to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\DiscIT" C:\SatisfactoryModLoader\Mods\DiscIT -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Copy JSONQuery to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\JSONQuery" C:\SatisfactoryModLoader\Mods\JSONQuery -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1

      - name: Generate VS project files
        run: C:\ue\Engine\Build\BatchFiles\Build.bat FactoryEditor Win64 Development -project="C:\\SatisfactoryModLoader\\FactoryGame.uproject"

      - name: Build for Development Editor
        run: C:\ue\Engine\\Build\\BatchFiles\\Build.bat FactoryEditor Win64 Development -project="C:\\SatisfactoryModLoader\\FactoryGame.uproject"

      - name: Package FicsitRemoteMonitoring Mod
        run: C:\ue\Engine\Build\BatchFiles\RunUAT.bat -ScriptsForProject='C:\\SatisfactoryModLoader\\FactoryGame.uproject' PackagePlugin -Project="C:\\SatisfactoryModLoader\\FactoryGame.uproject" -dlcname=FicsitRemoteMonitoring -build -server -clientconfig=Shipping -serverconfig=Shipping -platform=Win64 -serverplatform=Win64+Linux -nocompileeditor -installed

      - name: Copy uv.dll and zlib1.dll files to Windows Shipping
        run: 7z a "C:\\SatisfactoryModLoader\\Saved\\ArchivedPlugins\\FicsitRemoteMonitoring\\FicsitRemoteMonitoring-Windows.zip" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\uv.dll" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\zlib1.dll" -pBinaries/Win64

      - name: Copy uv.dll and zlib1.dll files to Windows Server Shipping
        run: 7z a "C:\\SatisfactoryModLoader\\Saved\\ArchivedPlugins\\FicsitRemoteMonitoring\\FicsitRemoteMonitoring-WindowsServer.zip" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\uv.dll" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\zlib1.dll" -pBinaries/Win64

      - name: Copy uv.dll and zlib1.dll files to combined Windows Shipping
        run: 7z a "C:\\SatisfactoryModLoader\\Saved\\ArchivedPlugins\\FicsitRemoteMonitoring\\FicsitRemoteMonitoring.zip" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\uv.dll" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\zlib1.dll" -pWindows/Binaries/Win64

      - name: Copy uv.dll and zlib1.dll files to combined Windows Server Shipping
        run: 7z a "C:\\SatisfactoryModLoader\\Saved\\ArchivedPlugins\\FicsitRemoteMonitoring\\FicsitRemoteMonitoring.zip" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\uv.dll" "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring\\Source\\ThirdParty\\uWebSockets\\lib\\zlib1.dll" -pWindowsServer/Binaries/Win64

      - name: Archive FRM artifact
        uses: actions/upload-artifact@v4
        with:
          name: frm
          path: C:\\SatisfactoryModLoader\\Saved\\ArchivedPlugins\\FicsitRemoteMonitoring\\*.zip