name: CI

on:
  push:
    branches:
      - main
      - dev
    paths:
      - ".github/**"
      - "FicsitRemoteMonitoring.uplugin"
      - "Content/**"
      - "Source/**"
      - "www/**"
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    branches:
      - "main"
      - "dev"
    paths:
      - ".github/**"
      - "Content/**"
      - "Source/**"
      - "www/**"
  workflow_dispatch:

jobs:
  build:
    if: github.event.pull_request.draft == false
    runs-on: self-hosted
    steps:

      - uses: actions/checkout@v4
        with:
          path: FicsitRemoteMonitoring

      - name: Ensure SML Project is up to date
        run: git -C C:\SatisfactoryModLoader pull

      - name: Remove any existing FRM
        run: Remove-Item "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring" -Recurse -ErrorAction Ignore -Confirm:$false

      - name: Read uPlugin
        id: uPlugin
        uses: ActionsTools/read-json-action@main
        with:
          file_path: "FicsitRemoteMonitoring/FicsitRemoteMonitoring.uPlugin"

      - name: Copy FicsitRemoteMonitoring to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\FicsitRemoteMonitoring" C:\SatisfactoryModLoader\Mods -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build for Development Editor
        run: C:\ue\Engine\\Build\\BatchFiles\\Build.bat FactoryEditor Win64 Development -project="C:\\SatisfactoryModLoader\\FactoryGame.uproject"

      - name: Package FicsitRemoteMonitoring Mod
        run: C:\ue\Engine\Build\BatchFiles\RunUAT.bat -ScriptsForProject='C:\\SatisfactoryModLoader\\FactoryGame.uproject' PackagePlugin -Project="C:\\SatisfactoryModLoader\\FactoryGame.uproject" -dlcname=FicsitRemoteMonitoring -build -server -clientconfig=Shipping -serverconfig=Shipping -platform=Win64 -serverplatform=Win64+Linux -nocompileeditor -installed

      - name: Extract, Copy DLLs to Windows/WindowsServer Builds, Create new Archives
        run: |

          Remove-Item C:\workspace\Archive\* -Recurse -ErrorAction Ignore -Confirm:$false
          Expand-Archive C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\FicsitRemoteMonitoring.zip C:\workspace\Archive

          Copy-Item "C:/SatisfactoryModLoader/Mods/FicsitRemoteMonitoring/Source/ThirdParty/uWebSockets/lib/*.dll" C:\workspace\Archive\Windows\Binaries\Win64 -Force -Confirm:$false -ErrorAction Ignore
          Copy-Item "C:/SatisfactoryModLoader/Mods/FicsitRemoteMonitoring/Source/ThirdParty/uWebSockets/lib/*.dll" C:\workspace\Archive\WindowsServer\Binaries\Win64 -Force -Confirm:$false -ErrorAction Ignore

          Remove-Item C:\workspace\Output\* -Recurse -ErrorAction Ignore -Confirm:$false
          Compress-Archive C:\workspace\Archive\* C:\workspace\Output\FicsitRemoteMonitoring.zip
          Compress-Archive C:\workspace\Archive\Windows\* C:\workspace\Output\FicsitRemoteMonitoring-Windows.zip
          Compress-Archive C:\workspace\Archive\WindowsServer\* C:\workspace\Output\FicsitRemoteMonitoring-WindowsServer.zip
          Compress-Archive C:\workspace\Archive\LinuxServer\* C:\workspace\Output\FicsitRemoteMonitoring-LinuxServer.zip

      - name: Prep UAT Logs for Upload
        if: failure()
        run: 7z a UAT_Log.7z "$env:appdata/Unreal Engine/AutomationTool/Logs/C+ue/*"

      - name: Upload artifacts - UnrealAutomationTool Logs
        uses: actions/upload-artifact@master
        if: failure()
        with:
          name: Logs
          path: UAT_Log.7z

      - name: Archive Client Build Artifact
        if: ${{ github.event.pull_request.draft || github.ref == 'refs/heads/dev' }}
        uses: actions/upload-artifact@v4
        with:
          name: Client Build
          path: C:/workspace/Output/FicsitRemoteMonitoring-Windows.zip

      - name: Archive Windows Server Build Artifact
        if: ${{ github.event.pull_request.draft || github.ref == 'refs/heads/dev' }}
        uses: actions/upload-artifact@v4
        with:
          name: Windows Server Build
          path: C:/workspace/Output/FicsitRemoteMonitoring-WindowsServer.zip

      - name: Archive Linux Server Build Artifact
        if: ${{ github.event.pull_request.draft || github.ref == 'refs/heads/dev' }}
        uses: actions/upload-artifact@v4
        with:
          name: Linux Server Build
          path: C:/workspace/Output/FicsitRemoteMonitoring-LinuxServer.zip

      - name: Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: C:/workspace/Output/*
          tag_name: "${{ steps.uPlugin.outputs.SemVersion }}-${{ github.run_number }}"