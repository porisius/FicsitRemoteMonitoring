name: CI

on:
  push:
    branches:
      - main
      - dev
    paths:
      - ".github/**"
      - "FicsitRemoteMonitoring.uplugin"
      - "Content/**"
      - "Source/**"
      - "www/**"
  pull_request:
    branches:
      - "main"
      - "dev"
    paths:
      - ".github/**"
      - "Content/**"
      - "Source/**"
      - "www/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:

      - uses: actions/checkout@v2
        with:
          path: FicsitRemoteMonitoring

      - name: Ensure SML Project is up to date
        run: git -C C:\SatisfactoryModLoader pull

      - name: Remove any existing FRM
        run: Remove-Item "C:\\SatisfactoryModLoader\\Mods\\FicsitRemoteMonitoring" -Recurse -ErrorAction Ignore -Confirm:$false

      - name: Copy FicsitRemoteMonitoring to Project
        run: Copy-Item "$Env:GITHUB_WORKSPACE\\FicsitRemoteMonitoring" C:\SatisfactoryModLoader\Mods -Recurse -Force -Confirm:$false -ErrorAction Ignore

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1

      - name: Build for Development Editor
        run: C:\ue\Engine\\Build\\BatchFiles\\Build.bat FactoryEditor Win64 Development -project="C:\\SatisfactoryModLoader\\FactoryGame.uproject"

      - name: Package FicsitRemoteMonitoring Mod
        run: C:\ue\Engine\Build\BatchFiles\RunUAT.bat -ScriptsForProject='C:\\SatisfactoryModLoader\\FactoryGame.uproject' PackagePlugin -Project="C:\\SatisfactoryModLoader\\FactoryGame.uproject" -dlcname=FicsitRemoteMonitoring -build -server -clientconfig=Shipping -serverconfig=Shipping -platform=Win64 -serverplatform=Win64+Linux -nocompileeditor -installed

      - name: Copy uv.dll and zlib1.dll files to Packaged Mod
        run: |
          7z a "C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\FicsitRemoteMonitoring-Windows.zip" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\uv.dll" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\zlib1.dll" -pBinaries/Win64
          7z a "C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\FicsitRemoteMonitoring-WindowsServer.zip" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\uv.dll" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\zlib1.dll" -pBinaries/Win64
          7z a "C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\FicsitRemoteMonitoring.zip" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\uv.dll" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\zlib1.dll" -pWindows/Binaries/Win64
          7z a "C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\FicsitRemoteMonitoring.zip" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\uv.dll" "C:\SatisfactoryModLoader\Mods\FicsitRemoteMonitoring\Source\ThirdParty\uWebSockets\lib\zlib1.dll" -pWindowsServer/Binaries/Win64

      - name: Stage for release
        run: |
          mkdir $Env:GITHUB_WORKSPACE\\Output
          Copy-Item C:\SatisfactoryModLoader\Saved\ArchivedPlugins\FicsitRemoteMonitoring\* "$Env:GITHUB_WORKSPACE\\Output"

  upload:
    runs-on: self-hosted
    needs: build
    if: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/dev' }}
    steps:
      - name: Archive Client Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Client Build
          path: Output/FicsitRemoteMonitoring-Windows.zip

      - name: Archive Windows Server Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows Server Build
          path: Output/FicsitRemoteMonitoring-WindowsServer.zip

      - name: Archive Linux Server Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux Server Build
          path: Output/FicsitRemoteMonitoring-LinuxServer.zip

  release:
    runs-on: self-hosted
    needs: [build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: Output/*
          tag_name: "${{ github.event_name }}-${{ github.run_number }}"